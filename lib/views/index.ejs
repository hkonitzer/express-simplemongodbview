<!doctype html>
<html>
  <head>
    <title>DB VIEWER</title>
    <meta name="viewport" content="width=device-width">    
    <link href="<%=cdnurl%>/css/main.css" rel="stylesheet" type="text/css"> 
    <link href="http://code.jquery.com/ui/1.10.3/themes/redmond/jquery-ui.css" rel="stylesheet" type="text/css">
    <!--<link href="<%=cdnurl%>/css/redmond/jquery-ui.css" rel="stylesheet" type="text/css">-->
    <script src="<%=cdnurl%>/js/libs/jquery-1.9.1.min.js"></script>
    <script src="<%=cdnurl%>/js/libs/jquery-ui-1.10.3.custom.min.js"></script>
    <script src="<%=cdnurl%>/js/libs/moment.min.js"></script>
    <script src="<%=cdnurl%>/js/libs/d3.v3.min.js"></script>
    <script src="<%=cdnurl%>/js/libs/underscore-min.js"></script>
    <script src="<%=cdnurl%>/js/libs/backbone-min.js"></script>  
  </head>
  <body>
    <div>
      <div id="menu" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
        <div class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
          <span>Collections</span>
        </div>
        
      </div>
      
      <div id="workbench" class="ui-tabs ui-widget ui-widget-content ui-corner-all">
        <div id="activecollection" class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all">
          
        </div>
      </div>
    </div>
    <script>
    var DataModel = Backbone.Model.extend({
      idAttribute: '_id'
    });
    var DataCollection = Backbone.Collection.extend({
      model: DataModel
    });
    var SchemaModel = Backbone.Model.extend({
      idAttribute: '_id',
      dataCollection: null
    });
    var SchemaCollection = Backbone.Collection.extend({
      model: SchemaModel
    });
    var CollectionView = Backbone.View.extend({      
      menuElem: $('<ul id="collectionList"></ul>'),
      workbenchElem: $('#activecollection'),
      events: {
        'click li': 'openWorkbench'
      },
      initialize: function(opts_) {
        this.listenTo(this.model, 'add', this.addCollectionToMenu);
      },
      render : function() {
        this.menuElem.menu();        
        this.$el.append(this.menuElem);
        this.menuElem.show();
        this.workbenchElem.append('<div id="activeCollectionHeader">Workbench: <span>(select a collection)</span></div>');        
      },
      addCollectionToMenu : function(model) {            
        var aElem = $('<a>', {          
          href: '#',
          text: model.get('modelName')
        })
        var liElem = $('<li>', {
          id: 'collection_'+model.get('modelName'),          
          html: aElem
        });
        liElem.data('modelId', model.cid);
        this.menuElem.append(liElem);
        return this;
      },
      openWorkbench: function(ev){
        var modelId = $(ev.currentTarget).data('modelId');
        var model = this.model.get(modelId);        
        this.workbenchElem.find('span').html(model.get('modelName'));        
      }
    });

    var schemas = new SchemaCollection();
    var collections = new CollectionView({model: schemas, el: $('#menu')});
    var temp = null;
    <% 
    for (var m in models) {
      
      %>
      var temp = new SchemaModel({modelName: '<%=models[m].modelName%>', keys: []});
      var dataModel = new DataModel();
      <%
      for (var keys in models[m].schema.tree) {
        %>
        temp.get('keys').push('<%=keys%>');
        dataModel.set('<%=keys%>', null);
        <%
      }
      %>
      temp.dataCollection = new DataCollection({model: dataModel});
      schemas.add(temp);
      <%
    } 
    %>
    collections.render();
    </script>
  </body>
</html>